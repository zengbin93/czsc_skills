---
name: fractal-detector
description: 识别K线图中的分型（顶分型和底分型）。当需要分析股票或期货K线数据以识别缠论中的分型结构时使用此技能。适用于：(1) 识别顶分型和底分型 (2) 分析分型的位置和特征 (3) 为笔识别提供基础数据 (4) 验证分型的有效性
---

# 分型识别器

## 概述

分型是缠论中最基础的概念，是构成笔和线段的基础元素。本技能帮助识别K线数据中的顶分型和底分型。

## 分型定义

### 顶分型
三根K线满足以下条件：
- 中间K线的高点是三根K线中最高的
- 中间K线的低点也是三根K线中最高的
- 即：第二根K线"包含"或"突出"于前后两根K线之上

### 底分型
三根K线满足以下条件：
- 中间K线的低点是三根K线中最低的  
- 中间K线的高点也是三根K线中最低的
- 即：第二根K线"包含"或"突出"于前后两根K线之下

## 工作流程

### 1. 数据准备

K线数据应包含以下字段：
```python
{
    "dt": "2024-01-01 09:30",  # 时间
    "open": 10.0,               # 开盘价
    "high": 10.5,               # 最高价
    "low": 9.8,                 # 最低价
    "close": 10.2,              # 收盘价
    "volume": 1000              # 成交量（可选）
}
```

### 2. 识别分型

遍历K线序列，检查每三根相邻K线：

**顶分型判断：**
```
if (k[i].high >= k[i-1].high and k[i].high >= k[i+1].high and
    k[i].low >= k[i-1].low and k[i].low >= k[i+1].low):
    # 发现顶分型
```

**底分型判断：**
```
if (k[i].low <= k[i-1].low and k[i].low <= k[i+1].low and
    k[i].high <= k[i-1].high and k[i].high <= k[i+1].high):
    # 发现底分型
```

### 3. 处理包含关系

在识别分型前，需要先处理K线的包含关系：

- **向上趋势**：两根K线有包含关系时，取高点的较高值和低点的较高值
- **向下趋势**：两根K线有包含关系时，取高点的较低值和低点的较低值

### 4. 分型结果

对每个识别出的分型，记录：
- 分型类型（顶分型/底分型）
- 分型位置（K线索引）
- 分型时间
- 关键价格（高点/低点）
- 分型强度（可选）

## 使用示例

### 示例 1：基础分型识别

用户请求：
```
帮我识别这组K线数据中的所有分型

[K线数据...]
```

处理步骤：
1. 验证数据格式
2. 处理包含关系
3. 遍历识别分型
4. 返回分型列表和可视化建议

### 示例 2：分型验证

用户请求：
```
验证第5根K线是否构成顶分型
```

处理步骤：
1. 检查位置有效性（至少有3根K线）
2. 获取相邻三根K线
3. 应用顶分型判断规则
4. 返回验证结果和原因

### 示例 3：结合 czsc 库

如果环境中可用 czsc 库：
```python
from czsc.analyze import CZSC

# 创建 CZSC 对象
czsc_obj = CZSC(klines)

# 获取分型列表
fractals = czsc_obj.fx_list

# 分析分型
for fx in fractals:
    print(f"{fx.dt}: {fx.fx_mark} - {fx.fx}")
```

## 注意事项

1. **最少K线数量**：至少需要3根K线才能识别分型
2. **包含关系处理**：必须先处理包含关系，否则会误判
3. **边界情况**：序列开头和结尾的K线无法判断分型
4. **严格判断**：使用 >= 和 <= 而非 > 和 <，以包含相等情况
5. **趋势确定**：处理包含关系时需要明确当前趋势方向

## 输出格式

返回结果建议采用以下格式：

```json
{
  "fractals": [
    {
      "type": "top",
      "index": 5,
      "dt": "2024-01-01 10:00",
      "high": 11.0,
      "low": 10.3
    },
    {
      "type": "bottom",
      "index": 8,
      "dt": "2024-01-01 11:30", 
      "high": 10.2,
      "low": 9.5
    }
  ],
  "top_count": 3,
  "bottom_count": 2,
  "total": 5
}
```

## 扩展功能

可以基于分型识别扩展以下功能：
- 笔的识别（需要顶底分型交替）
- 分型强度评估
- 分型有效性验证
- 分型信号生成
